# ============================================
# Anki Backend - Environment Variables
# ============================================
# 
# INSTRUCTIONS:
# 1. Copy this file to .env: cp .env.example .env
# 2. Fill in your actual values (especially secrets)
# 3. NEVER commit .env to version control!
#
# LOADING PRIORITY:
# - Environment variables from the system take precedence over .env file values
# - The application automatically tries to load .env if it exists (does not fail if missing)
# - This allows overriding .env values with system environment variables when needed
#
# SECURITY:
# - For production, use a secrets manager (AWS Secrets Manager, HashiCorp Vault, etc.)
# - Rotate secrets regularly
# - Never commit secrets to git
# - Use environment-specific values for different environments
#
# REQUIRED VARIABLES BY ENVIRONMENT:
# - Development: None (all values have defaults)
# - Staging/Production:
#   * JWT_SECRET_KEY (required, must be at least 32 characters)
#   * CORS_ALLOWED_ORIGINS (required in production, cannot be "*" or empty)
# - S3 Storage (if STORAGE_TYPE=s3):
#   * STORAGE_S3_BUCKET (required)
#   * STORAGE_S3_REGION (required)
#   * STORAGE_S3_KEY (required)
#   * STORAGE_S3_SECRET (required)
#
# DOCKER:
# - When using docker-compose, DB_HOST should be "postgres" and REDIS_HOST should be "redis"
# - For local development without Docker, use "localhost"
# ============================================

# ============================================
# Application Configuration
# ============================================

# Environment: development, staging, or production
ENV=development

# Log Level: debug, info, warn, or error
LOG_LEVEL=info

# ============================================
# Server Configuration
# ============================================

# Server host (0.0.0.0 to listen on all interfaces)
SERVER_HOST=0.0.0.0

# Server port
SERVER_PORT=8080

# Read timeout in seconds
SERVER_READ_TIMEOUT=30

# Write timeout in seconds
SERVER_WRITE_TIMEOUT=30

# Idle timeout in seconds
SERVER_IDLE_TIMEOUT=120

# Graceful shutdown timeout in seconds
# Maximum time to wait for HTTP server to shutdown gracefully before forcing shutdown
# Default: 10 seconds
SERVER_SHUTDOWN_TIMEOUT=10

# ============================================
# Database Configuration (PostgreSQL)
# ============================================

# Database host
# Use "postgres" when running with docker-compose
# Use "localhost" for local development without Docker
DB_HOST=postgres

# Database port
DB_PORT=5432

# Database user
DB_USER=postgres

# ⚠️ SECRET: Database password
# Change this in production! Use a strong password.
DB_PASSWORD=postgres

# Database name
DB_NAME=anki

# SSL Mode: disable, require, verify-ca, or verify-full
# Use "disable" for local development
# Use "require" or "verify-full" for production
DB_SSLMODE=disable

# Maximum number of connections in the pool
DB_MAX_CONNECTIONS=25

# Maximum number of idle connections
DB_MAX_IDLE_CONNS=5

# Connection max lifetime in minutes
DB_CONN_MAX_LIFETIME=5

# Connection max idle time in minutes
# Maximum time a connection can be idle before being closed
# Default: 10 minutes
DB_CONN_MAX_IDLE_TIME=10

# ============================================
# Redis Configuration
# ============================================

# Redis host
# Use "redis" when running with docker-compose
# Use "localhost" for local development without Docker
REDIS_HOST=redis

# Redis port
REDIS_PORT=6379

# ⚠️ SECRET: Redis password (optional, leave empty if not using password)
# If set, Redis will require authentication
REDIS_PASSWORD=

# Redis database number (0-15)
REDIS_DB=0

# ============================================
# JWT Configuration
# ============================================

# ⚠️ SECRET: JWT secret key (REQUIRED in production)
# Must be at least 32 characters long
# Generate a strong random string for production
# Example: openssl rand -base64 32
JWT_SECRET_KEY=your-secret-key-change-in-production-min-32-characters-long

# Access token expiry in minutes
JWT_ACCESS_TOKEN_EXPIRY=15

# Refresh token expiry in days
JWT_REFRESH_TOKEN_EXPIRY=7

# JWT issuer identifier
JWT_ISSUER=anki-api

# ============================================
# Storage Configuration
# ============================================

# Storage type: "local", "s3", "cloudflare", or "r2"
STORAGE_TYPE=local

# Local storage path (relative to application root or absolute path)
STORAGE_LOCAL_PATH=./storage

# S3 Configuration (only needed if STORAGE_TYPE=s3)
# ⚠️ SECRET: S3 credentials should be kept secure
STORAGE_S3_BUCKET=
STORAGE_S3_REGION=us-east-1
STORAGE_S3_KEY=
STORAGE_S3_SECRET=

# Cloudflare R2 Configuration (only needed if STORAGE_TYPE=cloudflare or r2)
# ⚠️ SECRET: Cloudflare R2 credentials should be kept secure
STORAGE_CLOUDFLARE_ACCOUNT_ID=
STORAGE_CLOUDFLARE_R2_BUCKET=
STORAGE_CLOUDFLARE_R2_KEY=
STORAGE_CLOUDFLARE_R2_SECRET=
# Optional: Custom endpoint (defaults to https://<account-id>.r2.cloudflarestorage.com)
STORAGE_CLOUDFLARE_R2_ENDPOINT=

# ============================================
# Optional: SMTP Configuration (Email)
# ============================================
# These are optional and only needed if email functionality is required
# Leave empty if not using email features

# SMTP server host
SMTP_HOST=

# SMTP server port (usually 587 for TLS or 465 for SSL)
SMTP_PORT=587

# SMTP username
SMTP_USER=

# ⚠️ SECRET: SMTP password
SMTP_PASSWORD=

# Email address to send from
SMTP_FROM=noreply@anki.com

# ============================================
# Rate Limiting Configuration
# ============================================

# Enable rate limiting (true/false)
RATE_LIMIT_ENABLED=true

# Rate limiting strategy: "redis" (distributed) or "memory" (single instance)
# Use "redis" for production with multiple instances
# Use "memory" for single instance or when Redis is unavailable
RATE_LIMIT_STRATEGY=redis

# Default rate limit per minute for all endpoints
RATE_LIMIT_DEFAULT_PER_MINUTE=60

# Burst size: extra requests allowed above the limit
RATE_LIMIT_BURST=10

# Enable per-endpoint rate limiting (true/false)
# When enabled, specific endpoints can have different limits
RATE_LIMIT_ENABLE_BY_ENDPOINT=false

# Login endpoint rate limit per minute (used when RATE_LIMIT_ENABLE_BY_ENDPOINT=true)
# Lower limit to prevent brute force attacks
RATE_LIMIT_LOGIN_PER_MINUTE=5

# ============================================
# CORS Configuration
# ============================================

# Enable CORS middleware (true/false)
# CORS is enabled by default for development
CORS_ENABLED=true

# Allowed origins (comma-separated, use * for all in development)
# Example: "http://localhost:3000,https://app.example.com"
# ⚠️ SECURITY: In production, never use "*" if CORS_ALLOW_CREDENTIALS=true
# In production, always specify explicit origins
CORS_ALLOWED_ORIGINS=*

# Allow credentials (cookies, authorization headers)
# ⚠️ SECURITY: If true, CORS_ALLOWED_ORIGINS must be explicit origins (not "*") in production
CORS_ALLOW_CREDENTIALS=true

# ============================================
# Session Configuration
# ============================================

# Session time-to-live in minutes
# Default: 30 minutes
SESSION_TTL_MINUTES=30

# Prefix for session keys in Redis
# Default: "session"
# Example: Keys will be stored as "session:{sessionID}"
SESSION_KEY_PREFIX=session

# ============================================
# Background Jobs Configuration
# ============================================

# Enable/disable background job processing system
# Default: true
JOBS_ENABLED=true

# Number of worker goroutines to process jobs
# More workers = higher throughput, but also higher resource usage
# Default: 5
JOBS_WORKER_COUNT=5

# Queue buffer size (max number of jobs that can be queued)
# Default: 1000
JOBS_QUEUE_SIZE=1000

# Maximum number of retries for failed jobs
# Default: 3
JOBS_MAX_RETRIES=3

# Base delay (in seconds) between retries
# Uses exponential backoff: delay * 2^retry_count
# Default: 5
JOBS_RETRY_DELAY_SECONDS=5

# Redis key prefix for job queue
# Default: "jobs:queue"
JOBS_REDIS_QUEUE_KEY=jobs:queue

# Redis database number for jobs (0-15)
# Use 1 to separate jobs from cache (default), or 0 to use same DB as cache
# Default: 1
JOBS_REDIS_DB=1

# ============================================
# Domain Events Configuration
# ============================================

# Enable/disable the domain events bus
# Default: true
EVENTS_ENABLED=true

# Number of concurrent workers to process domain events
# Default: 5
EVENTS_WORKER_COUNT=5

# Size of the internal event queue buffer
# Default: 1000
EVENTS_QUEUE_SIZE=1000

# ============================================
# Prometheus Metrics Configuration
# ============================================

# Enable/disable Prometheus metrics collection
# Default: true
METRICS_ENABLED=true

# Path for the metrics endpoint (where Prometheus will scrape)
# Default: /metrics
METRICS_PATH=/metrics

# Enable HTTP metrics (request count, duration, size)
# Default: true
METRICS_ENABLE_HTTP=true

# Enable system metrics (database connections, Redis stats)
# Default: true
METRICS_ENABLE_SYSTEM=true

# Enable business metrics (decks created, cards reviewed, etc.)
# Default: true
METRICS_ENABLE_BUSINESS=true

# ============================================
# Optional: Monitoring & Observability
# ============================================

# Sentry DSN for error tracking (optional)
# Leave empty if not using Sentry
SENTRY_DSN=

# ============================================
# Development Notes
# ============================================
#
# Quick Start:
# 1. Copy this file: cp .env.example .env
# 2. Update JWT_SECRET_KEY with a secure random string
# 3. Update DB_PASSWORD if needed
# 4. For Docker: DB_HOST=postgres, REDIS_HOST=redis
# 5. For local: DB_HOST=localhost, REDIS_HOST=localhost
#
# Production Checklist:
# - [ ] Change all default passwords
# - [ ] Set strong JWT_SECRET_KEY (min 32 chars)
# - [ ] Enable SSL for database (DB_SSLMODE=require)
# - [ ] Set ENV=production
# - [ ] Set LOG_LEVEL=info or warn
# - [ ] Use secrets manager for sensitive values
# - [ ] Configure proper CORS origins (explicit origins, not "*")
# - [ ] If CORS_ALLOW_CREDENTIALS=true, ensure CORS_ALLOWED_ORIGINS is not "*"
# - [ ] Set up monitoring (Sentry, etc.)
#
# ============================================
